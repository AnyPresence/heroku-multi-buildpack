#!/usr/bin/env ruby

$:.unshift File.expand_path("../../lib", __FILE__)
require 'multipack'
require 'tmpdir'

log "Processing #{TRIGGER_FILE_NAME}..."

repos = IO.readlines(TRIGGER_FILE)

repos.each do |git_repo|
  git_repo.strip!
  name = git_repo.split('/').last
  log "Cloning #{name}"
  Dir.mktmpdir(name) do |dir| 
    puts "Executing 'git clone #{git_repo} #{dir}'"
    output = `git clone #{git_repo} #{dir}`
    result = $?.success?
    if result
      log "Detecting"
      detect = `#{File.join(dir,'bin','detect')} #{WORK_DIR}`
      puts detect
    else
      log "Failed to clone #{git_repo}!"
      exit 1
    end
  end
end
