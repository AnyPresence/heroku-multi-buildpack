#!/usr/bin/env ruby

$:.unshift File.expand_path("../../lib", __FILE__)
require 'multipack'

log "Processing #{TRIGGER_FILE_NAME}..."

repos = IO.readlines(TRIGGER_FILE)
env_vars = ""
counter = 0
repos.each do |git_repo|
  git_repo.strip!
  name = git_repo.split('/').last
  log "Cloning #{name}"
  dir = File.join(WORK_DIR,name)
  FileUtils.mkdir(dir)
  output = `git clone #{git_repo} #{dir}`
  if $?.success?

    bin_dir = File.join(dir,'bin')
    detect = File.join(bin_dir,'detect')
    compile = File.join(bin_dir,'compile')
    release = File.join(bin_dir,'release')
    fix_executable_permissions(detect,compile,release)

    log "Detecting..."    
    detect_output = `#{detect} #{WORK_DIR}`
    if $?.success?
      puts detect_output
      log "Compiling..."
      compile_output = `#{compile} #{WORK_DIR} #{CACHE_DIR}`
      
      if $?.success?
        puts compile_output
        release_output = `#{release} #{WORK_DIR}`
        
        if $?.success?
          env_vars << release_output
          log "Collected release output"
          counter = counter + 1
        else
          log "Error releasing!"
        end
      else
        log "Error compiling #{compile_output}"
      end
    end
  else
    log "Failed to clone #{git_repo}!"
  end
  
  exit 1 unless $?.success?
end

log "Putting releases together..."
save_release_file(env_vars)
log "Done compiling all #{counter} buildpacks!"
exit 0